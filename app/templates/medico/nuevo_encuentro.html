{% extends "base.html" %}
{% block title %}Nuevo Encuentro Médico{% endblock %}
{% block content %}
<nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand"><i class="bi bi-hospital fs-4"></i> Sistema Clínico</span>
        <div class="d-flex align-items-center gap-3">
            <span class="text-light"><i class="bi bi-heart-pulse"></i> Dr(a). {{ user.nombres }} {{ user.apellidos }}</span>
            <a href="/logout" class="btn btn-secondary"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="mb-4">
        <a href="/dashboard" class="text-decoration-none text-primary"><i class="bi bi-arrow-left"></i> Volver al Dashboard</a>
        <h2 class="mt-2"><i class="bi bi-file-medical-fill"></i> Registrar Encuentro Médico</h2>
    </div>
    
    <div id="alert" class="alert d-none" role="alert"></div>
    
    <div class="card">
        <div class="card-body">
            <form id="formEncuentro">
                <div class="mb-3">
                    <label class="form-label">Paciente</label>
                    <select class="form-select" id="paciente_id" required>
                    <option value="">Seleccione un paciente</option>
                    {% for p in pacientes %}
                    <option value="{{ p.id }}">{{ p.nombres }} {{ p.apellidos }} - {{ p.numero_documento }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Tipo de Encuentro</label>
                <select class="form-select" id="tipo_id" required>
                    {% for t in tipos_encuentro %}
                    <option value="{{ t.id }}">{{ t.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Sede</label>
                <select class="form-select" id="sede_id" required>
                    {% for s in sedes %}
                    <option value="{{ s.id }}">{{ s.nombre }} - {{ s.ciudad }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Diagnóstico</label>
                <textarea class="form-control" id="diagnostico" rows="3" placeholder="Describa el diagnóstico"></textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Código ICD-10 (opcional)</label>
                <input type="text" class="form-control" id="diagnostico_codigo_icd10" placeholder="Ej: J00, A09">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Código SNOMED CT (opcional)</label>
                <input type="text" class="form-control" id="diagnostico_codigo_snomed" placeholder="Ej: 386661006">
            </div>
            
            <div class="observaciones-container">
                <h5 class="text-primary"><i class="bi bi-activity"></i> Observaciones Clínicas</h5>
                <div id="observacionesList"></div>
                <button type="button" class="btn btn-secondary" onclick="agregarObservacion()">+ Agregar Observación</button>
            </div>
            
            <div style="margin-top: 30px;">
                <button type="submit" class="btn btn-primary">Guardar Encuentro</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let obsCount = 0;

function agregarObservacion() {
    const container = document.getElementById('observacionesList');
    const div = document.createElement('div');
    div.className = 'observacion-form';
    div.id = `obs_${obsCount}`;
    div.innerHTML = `
        <div class="mb-3">
            <label class="form-label">Descripción</label>
            <input type="text" class="form-control obs-descripcion" required placeholder="Ej: Presión arterial, Temperatura">
        </div>
        <div class="mb-3">
            <label class="form-label">Valor</label>
            <input type="text" class="form-control obs-valor" placeholder="Ej: 120/80, 37.5">
        </div>
        <div class="mb-3">
            <label class="form-label">Unidad</label>
            <input type="text" class="form-control obs-unidad" placeholder="Ej: mmHg, °C, mg/dL">
        </div>
        <div class="mb-3">
            <label class="form-label">Código LOINC (opcional)</label>
            <input type="text" class="form-control obs-loinc" placeholder="Ej: 8480-6">
        </div>
        <div class="mb-3">
            <label class="form-label">Interpretación</label>
            <select class="form-select obs-interpretacion">
                <option value="">Seleccione</option>
                <option value="Normal">Normal</option>
                <option value="Anormal">Anormal</option>
                <option value="Alto">Alto</option>
                <option value="Bajo">Bajo</option>
                <option value="Crítico">Crítico</option>
            </select>
        </div>
        <button type="button" class="btn btn-danger btn-sm remove-obs" onclick="eliminarObservacion(${obsCount})">Eliminar</button>
    `;
    container.appendChild(div);
    obsCount++;
}

function eliminarObservacion(id) {
    document.getElementById(`obs_${id}`).remove();
}

document.getElementById('formEncuentro').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const observaciones = [];
    document.querySelectorAll('.observacion-form').forEach(form => {
        const desc = form.querySelector('.obs-descripcion').value;
        if (desc) {
            observaciones.push({
                descripcion: desc,
                valor: form.querySelector('.obs-valor').value || null,
                unidad: form.querySelector('.obs-unidad').value || null,
                codigo_loinc: form.querySelector('.obs-loinc').value || null,
                interpretacion: form.querySelector('.obs-interpretacion').value || null
            });
        }
    });
    
    const data = {
        paciente_id: parseInt(document.getElementById('paciente_id').value),
        tipo_id: parseInt(document.getElementById('tipo_id').value),
        sede_id: parseInt(document.getElementById('sede_id').value),
        diagnostico: document.getElementById('diagnostico').value || null,
        diagnostico_codigo_icd10: document.getElementById('diagnostico_codigo_icd10').value || null,
        diagnostico_codigo_snomed: document.getElementById('diagnostico_codigo_snomed').value || null,
        observaciones: observaciones
    };
    
    try {
        const response = await fetch('/encuentros/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            mostrarAlerta('Encuentro registrado correctamente. FHIR ID: ' + (result.fhir_encounter_id || 'Pendiente'), 'success');
            setTimeout(() => window.location.href = '/medico/consultas', 2000);
        } else {
            const error = await response.json();
            mostrarAlerta(error.detail || 'Error al guardar', 'error');
        }
    } catch (error) {
        mostrarAlerta('Error de conexión', 'error');
    }
});

function mostrarAlerta(mensaje, tipo) {
    const alert = document.getElementById('alert');
    alert.className = `alert alert-${tipo}`;
    alert.textContent = mensaje;
    alert.classList.remove('d-none');
    window.scrollTo(0, 0);
}
</script>
{% endblock %}
