{% extends "base.html" %}
{% block title %}Reportes y Estadísticas{% endblock %}
{% block content %}
<nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand"><i class="bi bi-hospital fs-4"></i> Sistema Clínico</span>
        <div class="d-flex align-items-center gap-3">
            <span class="text-light"><i class="bi bi-person-circle"></i> {{ user.nombres }} {{ user.apellidos }}</span>
            <a href="/logout" class="btn btn-secondary"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/dashboard" class="text-decoration-none text-primary"><i class="bi bi-arrow-left"></i> Volver al Dashboard</a>
            <h2 class="mt-2"><i class="bi bi-graph-up-arrow"></i> Reportes y Estadísticas</h2>
        </div>
        <button class="btn btn-primary" onclick="cargarEstadisticas()"><i class="bi bi-arrow-clockwise"></i> Actualizar</button>
    </div>
    
    <div id="loading" class="text-center py-5 d-none">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="text-primary mt-2">Cargando estadísticas...</p>
    </div>
    
    <!-- Resumen General -->
    <div class="row g-4 mb-4" id="resumenCards">
        <div class="col-md-6 col-lg-3">
            <div class="card text-center p-4">
                <div class="card-body">
                    <i class="bi bi-people-fill display-4 text-primary mb-3"></i>
                    <h3 id="totalUsuarios" class="display-5">-</h3>
                    <p class="text-muted mb-0">Usuarios Totales</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card text-center p-4">
                <div class="card-body">
                    <i class="bi bi-clipboard-pulse display-4 text-success mb-3"></i>
                    <h3 id="totalEncuentros" class="display-5">-</h3>
                    <p class="text-muted mb-0">Encuentros Médicos</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card text-center p-4">
                <div class="card-body">
                    <i class="bi bi-activity display-4 text-info mb-3"></i>
                    <h3 id="totalObservaciones" class="display-5">-</h3>
                    <p class="text-muted mb-0">Observaciones Clínicas</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card text-center p-4">
                <div class="card-body">
                    <i class="bi bi-building display-4 text-primary mb-3"></i>
                    <h3 id="totalSedes" class="display-5">-</h3>
                    <p class="text-muted mb-0">Sedes Activas</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detalles -->
    <div class="row g-4">
        
        <!-- Usuarios por Rol -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="bi bi-people-fill text-primary"></i> Usuarios por Rol</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Rol</th>
                                    <th>Cantidad</th>
                                </tr>
                            </thead>
                            <tbody id="tablaUsuariosRol">
                                <tr><td colspan="2" class="text-center">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-circle-fill text-success"></i> Activos: <strong id="usuariosActivos">-</strong></span>
                            <span><i class="bi bi-circle-fill text-danger"></i> Inactivos: <strong id="usuariosInactivos">-</strong></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Encuentros por Tipo -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="bi bi-clipboard-pulse text-success"></i> Encuentros por Tipo</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Cantidad</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEncuentrosTipo">
                                <tr><td colspan="2" class="text-center">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Encuentros por Sede -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="bi bi-building text-primary"></i> Encuentros por Sede</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Sede</th>
                                    <th>Cantidad</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEncuentrosSede">
                                <tr><td colspan="2" class="text-center">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FHIR Sincronización -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="bi bi-link-45deg text-info"></i> Sincronización HAPI FHIR</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center p-3 mb-3 bg-light rounded">
                        <span>Pacientes sincronizados (Patient)</span>
                        <h3 id="pacientesFhir" class="text-primary mb-0">-</h3>
                    </div>
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                        <span>Médicos sincronizados (Practitioner)</span>
                        <h3 id="medicosFhir" class="text-success mb-0">-</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function cargarEstadisticas() {
    document.getElementById('loading').classList.remove('d-none');
    
    try {
        const response = await fetch('/reportes/estadisticas');
        const data = await response.json();
        
        // Resumen
        document.getElementById('totalUsuarios').textContent = data.usuarios.total;
        document.getElementById('totalEncuentros').textContent = data.encuentros.total;
        document.getElementById('totalObservaciones').textContent = data.observaciones.total;
        document.getElementById('totalSedes').textContent = data.sedes.activas;
        
        // Usuarios activos/inactivos
        document.getElementById('usuariosActivos').textContent = data.usuarios.activos;
        document.getElementById('usuariosInactivos').textContent = data.usuarios.inactivos;
        
        // Tabla usuarios por rol
        const tablaRol = document.getElementById('tablaUsuariosRol');
        if (data.usuarios.por_rol.length > 0) {
            tablaRol.innerHTML = data.usuarios.por_rol.map(r => 
                `<tr><td>${r.rol}</td><td>${r.total}</td></tr>`
            ).join('');
        } else {
            tablaRol.innerHTML = '<tr><td colspan="2" style="text-align: center;">Sin datos</td></tr>';
        }
        
        // Tabla encuentros por tipo
        const tablaTipo = document.getElementById('tablaEncuentrosTipo');
        if (data.encuentros.por_tipo.length > 0) {
            tablaTipo.innerHTML = data.encuentros.por_tipo.map(t => 
                `<tr><td>${t.tipo}</td><td>${t.total}</td></tr>`
            ).join('');
        } else {
            tablaTipo.innerHTML = '<tr><td colspan="2" style="text-align: center;">Sin datos</td></tr>';
        }
        
        // Tabla encuentros por sede
        const tablaSede = document.getElementById('tablaEncuentrosSede');
        if (data.encuentros.por_sede.length > 0) {
            tablaSede.innerHTML = data.encuentros.por_sede.map(s => 
                `<tr><td>${s.sede}</td><td>${s.total}</td></tr>`
            ).join('');
        } else {
            tablaSede.innerHTML = '<tr><td colspan="2" style="text-align: center;">Sin datos</td></tr>';
        }
        
        // FHIR
        document.getElementById('pacientesFhir').textContent = data.fhir.pacientes_sincronizados;
        document.getElementById('medicosFhir').textContent = data.fhir.medicos_sincronizados;
        
    } catch (error) {
        console.error('Error:', error);
    }
    
    document.getElementById('loading').classList.add('d-none');
}

// Cargar al iniciar
cargarEstadisticas();
</script>
{% endblock %}
