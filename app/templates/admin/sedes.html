{% extends "base.html" %}
{% block title %}Gestión de Sedes{% endblock %}
{% block content %}
<nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand"><i class="bi bi-hospital fs-4"></i> Sistema Clínico</span>
        <div class="d-flex align-items-center gap-3">
            <span class="text-light"><i class="bi bi-person-circle"></i> {{ user.nombres }} {{ user.apellidos }}</span>
            <a href="/logout" class="btn btn-secondary"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/dashboard" class="text-decoration-none text-primary"><i class="bi bi-arrow-left"></i> Volver al Dashboard</a>
            <h2 class="mt-2"><i class="bi bi-building-fill"></i> Gestión de Sedes</h2>
        </div>
        <button class="btn btn-success" onclick="abrirModal()"><i class="bi bi-plus-lg"></i> Nueva Sede</button>
    </div>
    
    <div id="alert" class="alert d-none" role="alert"></div>
    
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Ciudad</th>
                            <th>Dirección</th>
                            <th>Teléfono</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in sedes %}
                        <tr>
                            <td>{{ s.id }}</td>
                            <td>{{ s.nombre }}</td>
                            <td>{{ s.ciudad }}</td>
                            <td>{{ s.direccion or 'Sin dirección' }}</td>
                            <td>{{ s.telefono or 'Sin teléfono' }}</td>
                            <td><span class="badge {{ 'bg-success' if s.activo else 'bg-secondary' }}">{{ 'Activo' if s.activo else 'Inactivo' }}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editarSede({{ s.id }}, '{{ s.nombre }}', '{{ s.ciudad }}', '{{ s.direccion or '' }}', '{{ s.telefono or '' }}')"><i class="bi bi-pencil-fill"></i></button>
                                <button class="btn btn-sm {{ 'btn-warning' if s.activo else 'btn-success' }}" onclick="toggleEstado({{ s.id }})"><i class="bi bi-{{ 'pause-fill' if s.activo else 'play-fill' }}"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarSede({{ s.id }}, '{{ s.nombre }}')"><i class="bi bi-trash-fill"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sede -->
<div class="modal fade" id="modalSede" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo">Nueva Sede</h5>
                <button type="button" class="btn-close btn-close-white" onclick="cerrarModal()"></button>
            </div>
            <div class="modal-body">
                <form id="formSede">
                    <input type="hidden" id="sedeId">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ciudad</label>
                        <input type="text" class="form-control" id="ciudad" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="direccion">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teléfono</label>
                        <input type="text" class="form-control" id="telefono">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" form="formSede" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill text-warning"></i> Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" onclick="cerrarModalEliminar()"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar la sede <strong id="nombreEliminar"></strong>?</p>
                <input type="hidden" id="eliminarSedeId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalEliminar()">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarEliminar()">Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editando = false;
const modalSede = new bootstrap.Modal(document.getElementById('modalSede'));
const modalEliminar = new bootstrap.Modal(document.getElementById('modalEliminar'));

function abrirModal() {
    editando = false;
    document.getElementById('modalTitulo').textContent = 'Nueva Sede';
    document.getElementById('formSede').reset();
    document.getElementById('sedeId').value = '';
    modalSede.show();
}

function cerrarModal() {
    modalSede.hide();
}

function cerrarModalEliminar() {
    modalEliminar.hide();
}

function editarSede(id, nombre, ciudad, direccion, telefono) {
    editando = true;
    document.getElementById('modalTitulo').textContent = 'Editar Sede';
    document.getElementById('sedeId').value = id;
    document.getElementById('nombre').value = nombre;
    document.getElementById('ciudad').value = ciudad;
    document.getElementById('direccion').value = direccion;
    document.getElementById('telefono').value = telefono;
    modalSede.show();
}

async function toggleEstado(id) {
    const response = await fetch(`/sedes/${id}/toggle-estado`, { method: 'PATCH' });
    if (response.ok) {
        const result = await response.json();
        mostrarAlerta(result.message, 'success');
        setTimeout(() => location.reload(), 1000);
    } else {
        mostrarAlerta('Error al cambiar estado', 'danger');
    }
}

function eliminarSede(id, nombre) {
    document.getElementById('eliminarSedeId').value = id;
    document.getElementById('nombreEliminar').textContent = nombre;
    modalEliminar.show();
}

async function confirmarEliminar() {
    const id = document.getElementById('eliminarSedeId').value;
    const response = await fetch(`/sedes/${id}`, { method: 'DELETE' });
    
    if (response.ok) {
        mostrarAlerta('Sede eliminada', 'success');
        cerrarModalEliminar();
        setTimeout(() => location.reload(), 1000);
    } else {
        mostrarAlerta('Error al eliminar sede', 'danger');
    }
}

document.getElementById('formSede').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('sedeId').value;
    const url = editando ? `/sedes/${id}` : '/sedes/';
    const method = editando ? 'PUT' : 'POST';
    
    const data = {
        nombre: document.getElementById('nombre').value,
        ciudad: document.getElementById('ciudad').value,
        direccion: document.getElementById('direccion').value || null,
        telefono: document.getElementById('telefono').value || null
    };
    
    const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        mostrarAlerta(editando ? 'Sede actualizada' : 'Sede creada', 'success');
        cerrarModal();
        setTimeout(() => location.reload(), 1000);
    } else {
        const error = await response.json();
        mostrarAlerta(error.detail || 'Error al guardar', 'danger');
    }
});

function mostrarAlerta(mensaje, tipo) {
    const alert = document.getElementById('alert');
    alert.className = `alert alert-${tipo}`;
    alert.textContent = mensaje;
    alert.classList.remove('d-none');
    setTimeout(() => alert.classList.add('d-none'), 3000);
}
</script>
{% endblock %}
