{% extends "base.html" %}
{% block title %}Gestión de Roles{% endblock %}
{% block content %}
<nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand"><i class="bi bi-hospital fs-4"></i> Sistema Clínico</span>
        <div class="d-flex align-items-center gap-3">
            <span class="text-light"><i class="bi bi-person-circle"></i> {{ user.nombres }} {{ user.apellidos }}</span>
            <a href="/logout" class="btn btn-secondary"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/dashboard" class="text-decoration-none text-primary"><i class="bi bi-arrow-left"></i> Volver al Dashboard</a>
            <h2 class="mt-2"><i class="bi bi-shield-lock-fill"></i> Gestión de Roles</h2>
        </div>
        <button class="btn btn-success" onclick="abrirModal()"><i class="bi bi-plus-lg"></i> Nuevo Rol</button>
    </div>
    
    <div id="alert" class="alert d-none" role="alert"></div>
    
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in roles %}
                        <tr>
                            <td>{{ r.id }}</td>
                            <td>{{ r.nombre }}</td>
                            <td>{{ r.descripcion or 'Sin descripción' }}</td>
                            <td><span class="badge {{ 'bg-success' if r.activo else 'bg-secondary' }}">{{ 'Activo' if r.activo else 'Inactivo' }}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editarRol({{ r.id }}, '{{ r.nombre }}', '{{ r.descripcion or '' }}')"><i class="bi bi-pencil-fill"></i> Editar</button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarRol({{ r.id }})"><i class="bi bi-trash-fill"></i> Eliminar</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalRol" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo">Nuevo Rol</h5>
                <button type="button" class="btn-close btn-close-white" onclick="cerrarModal()"></button>
            </div>
            <div class="modal-body">
                <form id="formRol">
                    <input type="hidden" id="rolId">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcion" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" form="formRol" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editando = false;
const modalElement = document.getElementById('modalRol');
const modal = new bootstrap.Modal(modalElement);

function abrirModal() {
    editando = false;
    document.getElementById('modalTitulo').textContent = 'Nuevo Rol';
    document.getElementById('formRol').reset();
    document.getElementById('rolId').value = '';
    modal.show();
}

function cerrarModal() {
    modal.hide();
}

function editarRol(id, nombre, descripcion) {
    editando = true;
    document.getElementById('modalTitulo').textContent = 'Editar Rol';
    document.getElementById('rolId').value = id;
    document.getElementById('nombre').value = nombre;
    document.getElementById('descripcion').value = descripcion;
    modal.show();
}

async function eliminarRol(id) {
    if (!confirm('¿Está seguro de eliminar este rol?')) return;
    
    const response = await fetch(`/roles/${id}`, { method: 'DELETE' });
    if (response.ok) {
        mostrarAlerta('Rol eliminado correctamente', 'success');
        setTimeout(() => location.reload(), 1000);
    } else {
        mostrarAlerta('Error al eliminar rol', 'danger');
    }
}

document.getElementById('formRol').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('rolId').value;
    const url = editando ? `/roles/${id}` : '/roles/';
    const method = editando ? 'PUT' : 'POST';
    
    const data = {
        nombre: document.getElementById('nombre').value,
        descripcion: document.getElementById('descripcion').value || null
    };
    
    const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        mostrarAlerta(editando ? 'Rol actualizado' : 'Rol creado', 'success');
        cerrarModal();
        setTimeout(() => location.reload(), 1000);
    } else {
        const error = await response.json();
        mostrarAlerta(error.detail || 'Error al guardar', 'danger');
    }
});

function mostrarAlerta(mensaje, tipo) {
    const alert = document.getElementById('alert');
    alert.className = `alert alert-${tipo}`;
    alert.textContent = mensaje;
    alert.classList.remove('d-none');
    setTimeout(() => alert.classList.add('d-none'), 3000);
}
</script>
{% endblock %}
