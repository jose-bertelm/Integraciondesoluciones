{% extends "base.html" %}
{% block title %}Gesti√≥n de Usuarios{% endblock %}
{% block content %}
<nav class="navbar navbar-dark sticky-top">
    <div class="container-fluid">
        <span class="navbar-brand"><i class="bi bi-hospital fs-4"></i> Sistema Cl√≠nico</span>
        <div class="d-flex align-items-center gap-3">
            <span class="text-light"><i class="bi bi-person-circle"></i> {{ user.nombres }} {{ user.apellidos }}</span>
            <a href="/logout" class="btn btn-secondary"><i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/dashboard" class="text-decoration-none text-primary"><i class="bi bi-arrow-left"></i> Volver al Dashboard</a>
            <h2 class="mt-2"><i class="bi bi-people-fill"></i> Gesti√≥n de Usuarios</h2>
        </div>
        <button class="btn btn-success" onclick="abrirModal()"><i class="bi bi-plus-lg"></i> Nuevo Usuario</button>
    </div>
    
    <div id="alert" class="alert d-none" role="alert"></div>
    
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre Completo</th>
                    <th>Documento</th>
                    <th>Rol</th>
                    <th>Sede</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaUsuarios">
                {% for u in usuarios %}
                <tr id="row-{{ u.id }}">
                    <td>{{ u.id }}</td>
                    <td>{{ u.nombres }} {{ u.apellidos }}</td>
                    <td>{{ u.tipo_documento.prefijo if u.tipo_documento else '' }} {{ u.numero_documento }}</td>
                    <td>{{ u.rol.nombre if u.rol else 'Sin rol' }}</td>
                    <td>{{ u.sede_registro.nombre if u.sede_registro else 'Sin sede' }}</td>
                    <td>
                        <span class="estado-badge {{ 'estado-activo' if u.activo else 'estado-inactivo' }}">
                            {{ 'Activo' if u.activo else 'Inactivo' }}
                        </span>
                    </td>
                    <td class="acciones-btns">
                        <button class="btn btn-primary btn-sm" onclick="editarUsuario({{ u.id }})">‚úèÔ∏è Editar</button>
                        <button class="btn {{ 'btn-warning' if u.activo else 'btn-success' }} btn-sm" onclick="toggleEstado({{ u.id }}, {{ 'true' if u.activo else 'false' }})">
                            {{ '‚è∏Ô∏è Desactivar' if u.activo else '‚ñ∂Ô∏è Activar' }}
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarUsuario({{ u.id }}, '{{ u.nombres }} {{ u.apellidos }}')">üóëÔ∏è Eliminar</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Usuario -->
<div class="modal fade" id="modalUsuario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo">Nuevo Usuario</h5>
                <button type="button" class="btn-close btn-close-white" onclick="cerrarModal()"></button>
            </div>
            <div class="modal-body">
                <form id="formUsuario">
                    <input type="hidden" id="usuarioId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombres</label>
                            <input type="text" class="form-control" id="nombres" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellidos</label>
                            <input type="text" class="form-control" id="apellidos" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo de Documento</label>
                            <select class="form-select" id="tipo_documento_id" required>
                    {% for td in tipos_documento %}
                    <option value="{{ td.id }}">{{ td.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">N√∫mero de Documento</label>
                <input type="text" class="form-control" id="numero_documento" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Fecha de Nacimiento</label>
                <input type="date" class="form-control" id="fecha_nacimiento" required>
            </div>
            <div class="mb-3">
                <label class="form-label">G√©nero</label>
                <select class="form-select" id="genero" required>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Tel√©fono</label>
                <input type="text" class="form-control" id="telefono">
            </div>
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="email">
            </div>
            <div class="mb-3">
                <label class="form-label">Sede</label>
                <select class="form-select" id="sede_registro_id" required>
                    {% for s in sedes %}
                    <option value="{{ s.id }}">{{ s.nombre }} - {{ s.ciudad }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Rol</label>
                <select class="form-select" id="rol_id" required>
                    {% for r in roles %}
                    <option value="{{ r.id }}">{{ r.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3" id="passwordGroup">
                <label class="form-label">Contrase√±a</label>
                <input type="password" class="form-control" id="password">
            </div>
            <button type="submit" class="btn btn-primary">Guardar</button>
        </form>
    </div>
</div>

<!-- Modal Confirmar Eliminaci√≥n -->
<div id="modalEliminar" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
            <button class="modal-close" onclick="cerrarModalEliminar()">&times;</button>
        </div>
        <p style="margin-bottom: 20px;">¬øEst√° seguro que desea eliminar permanentemente al usuario <strong id="nombreEliminar"></strong>?</p>
        <p class="text-danger mb-3">Esta acci√≥n no se puede deshacer y eliminar√° el registro de HAPI FHIR.</p>
        <input type="hidden" id="eliminarUsuarioId">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="cerrarModalEliminar()" style="flex: 1;">Cancelar</button>
            <button class="btn btn-danger" onclick="confirmarEliminar()" style="flex: 1;">Eliminar</button>
        </div>
    </div>
</div>

<style>
.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
}
.btn-warning {
    background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
    color: #fff;
}
.acciones-btns {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}
.estado-badge {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
}
.estado-activo {
    background: #d1fae5;
    color: #10b981;
    border: 1px solid #10b981;
}
.estado-inactivo {
    background: #fee2e2;
    color: #ef4444;
    border: 1px solid #ef4444;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let editando = false;
const modalUsuario = new bootstrap.Modal(document.getElementById('modalUsuario'));

function abrirModal() {
    editando = false;
    document.getElementById('modalTitulo').textContent = 'Nuevo Usuario';
    document.getElementById('formUsuario').reset();
    document.getElementById('usuarioId').value = '';
    document.getElementById('passwordGroup').style.display = 'block';
    document.getElementById('password').required = true;
    document.getElementById('numero_documento').disabled = false;
    modalUsuario.show();
}

function cerrarModal() {
    modalUsuario.hide();
}

function cerrarModalEliminar() {
    modalEliminar.hide();
}

async function editarUsuario(id) {
    editando = true;
    const response = await fetch(`/usuarios/${id}`);
    const usuario = await response.json();
    
    document.getElementById('modalTitulo').textContent = 'Editar Usuario';
    document.getElementById('usuarioId').value = usuario.id;
    document.getElementById('nombres').value = usuario.nombres;
    document.getElementById('apellidos').value = usuario.apellidos;
    document.getElementById('tipo_documento_id').value = usuario.tipo_documento_id;
    document.getElementById('numero_documento').value = usuario.numero_documento;
    document.getElementById('numero_documento').disabled = true;
    document.getElementById('fecha_nacimiento').value = usuario.fecha_nacimiento;
    document.getElementById('genero').value = usuario.genero;
    document.getElementById('telefono').value = usuario.telefono || '';
    document.getElementById('email').value = usuario.email || '';
    document.getElementById('sede_registro_id').value = usuario.sede_registro_id;
    document.getElementById('rol_id').value = usuario.rol_id;
    document.getElementById('passwordGroup').style.display = 'none';
    document.getElementById('password').required = false;
    
    modalUsuario.show();
}

async function toggleEstado(id, estadoActual) {
    const nuevoEstado = !estadoActual;
    const response = await fetch(`/usuarios/${id}/toggle-estado`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ activo: nuevoEstado })
    });
    
    if (response.ok) {
        mostrarAlerta(`Usuario ${nuevoEstado ? 'activado' : 'desactivado'} correctamente`, 'success');
        setTimeout(() => location.reload(), 1000);
    } else {
        const error = await response.json();
        mostrarAlerta(error.detail || 'Error al cambiar estado', 'error');
    }
}

function eliminarUsuario(id, nombre) {
    document.getElementById('eliminarUsuarioId').value = id;
    document.getElementById('nombreEliminar').textContent = nombre;
    document.getElementById('modalEliminar').classList.add('active');
}

async function confirmarEliminar() {
    const id = document.getElementById('eliminarUsuarioId').value;
    const response = await fetch(`/usuarios/${id}`, { method: 'DELETE' });
    
    if (response.ok) {
        mostrarAlerta('Usuario eliminado completamente', 'success');
        cerrarModalEliminar();
        setTimeout(() => location.reload(), 1000);
    } else {
        const error = await response.json();
        mostrarAlerta(error.detail || 'Error al eliminar usuario', 'error');
    }
}

document.getElementById('formUsuario').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('usuarioId').value;
    const url = editando ? `/usuarios/${id}` : '/usuarios/';
    const method = editando ? 'PUT' : 'POST';
    
    const data = {
        nombres: document.getElementById('nombres').value,
        apellidos: document.getElementById('apellidos').value,
        tipo_documento_id: parseInt(document.getElementById('tipo_documento_id').value),
        numero_documento: document.getElementById('numero_documento').value,
        fecha_nacimiento: document.getElementById('fecha_nacimiento').value,
        genero: document.getElementById('genero').value,
        telefono: document.getElementById('telefono').value || null,
        email: document.getElementById('email').value || null,
        sede_registro_id: parseInt(document.getElementById('sede_registro_id').value),
        rol_id: parseInt(document.getElementById('rol_id').value)
    };
    
    if (!editando) {
        data.password = document.getElementById('password').value;
    }
    
    const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        mostrarAlerta(editando ? 'Usuario actualizado' : 'Usuario creado', 'success');
        cerrarModal();
        setTimeout(() => location.reload(), 1000);
    } else {
        const error = await response.json();
        mostrarAlerta(error.detail || 'Error al guardar', 'error');
    }
});

function mostrarAlerta(mensaje, tipo) {
    const alert = document.getElementById('alert');
    alert.className = `alert alert-${tipo}`;
    alert.textContent = mensaje;
    alert.classList.remove('d-none');
    setTimeout(() => alert.classList.add('d-none'), 3000);
}
</script>
{% endblock %}
